<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pelanggan - Mechajob</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* --- Variabel Warna --- */
        :root {
            --orange: #ff9800;
            --blue: #2a6ed4;
            --light-bg: #f4f7f9;
            --green: #4CAF50;
            --red: #F44336;
        }

        /* --- GAYA DASAR --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg); 
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Header/Navigasi --- */
        .header {
            background-color: var(--blue); 
            box-shadow: 0 5px 0 0 var(--orange) inset;
            padding: 10px 20px; 
            display: flex;
            justify-content: space-between; 
            align-items: center;
            position: relative; 
            height: 100px; 
        }

        .header .logo-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            position: absolute;
            left: 50%;
            top: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 20; 
        }

        .header h1 { color: white; margin: 0; font-size: 24px; }
        .menu-icon {
            font-size: 30px;
            color: white; 
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 30; 
        }

        /* --- Dropdown Menu --- */
        .dropdown-menu {
            display: none; 
            position: absolute;
            top: 100%; 
            right: 0;
            background-color: #ffffff;
            min-width: 180px;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 40; 
        }
        .dropdown-menu.active { display: block; }
        .menu-item {
            padding: 12px 16px;
            text-decoration: none;
            display: block; 
            color: #333;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s; 
            font-size: 14px;
        }
        .menu-item:hover { background-color: #f1f1f1; }
        .logout-btn { color: var(--red); font-weight: bold; }

        /* --- Konten Utama (Dashboard) --- */
        .main-content {
            flex-grow: 1;
            padding: 30px 20px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        @media (min-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr 2fr; /* Profil di kiri, Daftar di kanan */
            }
        }
        
        .box {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        
        /* Profil Card */
        .profile-card h3 {
            color: var(--blue);
            margin-top: 0;
            border-bottom: 2px solid var(--blue);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .profile-info p {
            margin: 8px 0;
            font-size: 15px;
            display: flex;
            align-items: center;
        }
        .profile-info i {
            width: 25px;
            color: var(--orange);
        }
        .profile-info strong {
            font-weight: 600;
        }

        /* Tombol Pesanan Baru */
        .new-order-btn {
            background-color: var(--green);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
            display: block;
        }
        .new-order-btn:hover {
            background: #45a049;
        }

        /* Daftar Riwayat */
        .history-card h3 {
            color: var(--orange);
            margin-top: 0;
            border-bottom: 2px solid var(--orange);
            padding-bottom: 10px;
        }
        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        .order-table th, .order-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .order-table th {
            background-color: #f1f1f1;
            font-weight: bold;
            color: #555;
        }
        .order-table tr:hover {
            background-color: #f9f9f9;
        }

        /* Status Tags */
        .status-tag {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            display: inline-block;
        }
        .status-tag.pending { background-color: #795548; }
        .status-tag.in-progress { background-color: var(--blue); }
        .status-tag.selesai { background-color: var(--green); }
        .status-tag.batal { background-color: var(--red); }
        .status-tag.lunas { background-color: #00bcd4; }
        
        /* Placeholder saat loading */
        .loading-text {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #777;
        }

        /* --- Footer --- */
        .footer {
            background-color: #333;
            color: white;
            padding: 20px;
            text-align: center;
            border-top: 5px solid var(--orange);
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="logo-link">
            <h1><i class="fas fa-motorcycle"></i> Mechajob</h1>
        </a>
        <div class="menu-icon"><i class="fas fa-user-circle"></i></div> 

        <div class="dropdown-menu">
            <a href="customer-dashboard.html" class="menu-item"><i class="fas fa-home"></i> Dashboard</a>
            <a href="order-new.html" class="menu-item"><i class="fas fa-tools"></i> Buat Pesanan</a>
            <a href="#" id="logoutBtn" class="menu-item logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>  
        </div>
    </div>

    <div class="main-content">
        <h2 style="color: var(--blue); margin-top: 0;"><i class="fas fa-tachometer-alt"></i> Dashboard Pelanggan</h2>
        <div id="loadingIndicator" class="loading-text">Memuat data pelanggan...</div>

        <div class="dashboard-grid" style="display: none;" id="dashboardContent">
            
            <div class="profile-area">
                <div class="box profile-card">
                    <h3><i class="fas fa-id-card-alt" style="margin-right: 10px;"></i> Profil Saya</h3>
                    <div class="profile-info" id="customerProfile">
                        <p><i class="fas fa-user"></i> Nama: <strong id="profileFullName">N/A</strong></p>
                        <p><i class="fas fa-envelope"></i> Email: <strong id="profileEmail">N/A</strong></p>
                        <p><i class="fab fa-whatsapp"></i> Telepon: <strong id="profilePhone">N/A</strong></p>
                        <p><i class="fas fa-map-marker-alt"></i> Alamat: <strong id="profileAddress">N/A</strong></p>
                    </div>
                </div>

                <a href="order-new.html" class="new-order-btn">
                    <i class="fas fa-plus-circle"></i> Pesan Layanan Baru Sekarang
                </a>
            </div>

            <div class="history-card">
                <div class="box">
                    <h3><i class="fas fa-history" style="margin-right: 10px;"></i> Riwayat Pesanan Anda</h3>
                    <div id="orderHistory">
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>ID Tiket</th>
                                    <th>Layanan</th>
                                    <th>Tanggal</th>
                                    <th>Status</th>
                                    <th>Total Biaya</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="orderListBody">
                                </tbody>
                        </table>
                        <p id="noOrderMessage" style="text-align: center; color: #777; padding: 20px; display: none;">Anda belum memiliki riwayat pesanan.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Mechajob. Hak Cipta Dilindungi.</p>
    </footer>

    <script type="module">
        // =========================================================
        // 1. KONFIGURASI DAN IMPOR FIREBASE
        // =========================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyB_pygYC3UubxRWZScPO-GveCi8jh_zkdc",
            authDomain: "mechajob-b7360.firebaseapp.com",
            projectId: "mechajob-b7360",
            storageBucket: "mechajob-b7360.firebasestorage.app",
            messagingSenderId: "753002885541",
            appId: "1:753002885541:web:96e4964dbd300193ff384c",
            measurementId: "G-ZY3RS8WGP7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const dashboardContent = document.getElementById('dashboardContent');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Fungsi Helper untuk format mata uang
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        };
        
        // Fungsi Helper untuk tag status
        const getStatusTag = (status) => {
            let className = '';
            let text = status.toUpperCase();
            switch(status) {
                case 'pending': className = 'pending'; text = 'Menunggu Mekanik'; break;
                case 'in-progress': className = 'in-progress'; text = 'Diproses'; break;
                case 'selesai': className = 'selesai'; text = 'Selesai'; break;
                case 'batal': className = 'batal'; text = 'Dibatalkan'; break;
                default: className = 'pending';
            }
            return `<span class="status-tag ${className}">${text}</span>`;
        };

        // =========================================================
        // 2. LOGIKA OTENTIKASI DAN MEMUAT DATA
        // =========================================================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User sudah login
                loadCustomerProfile(user.uid);
                loadOrderHistory(user.uid);
            } else {
                // User belum login, redirect ke halaman login
                alert("Anda harus login sebagai pelanggan untuk mengakses dashboard.");
                window.location.href = "login-customer-auth.html";
            }
        });

        // --- Muat Data Profil Pelanggan ---
        async function loadCustomerProfile(uid) {
            try {
                const docRef = doc(db, "customer_users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profileFullName').textContent = data.fullName || 'N/A';
                    document.getElementById('profileEmail').textContent = data.email || 'N/A';
                    document.getElementById('profilePhone').textContent = data.phone || 'N/A';
                    document.getElementById('profileAddress').textContent = data.address || 'N/A';

                    loadingIndicator.style.display = 'none';
                    dashboardContent.style.display = 'grid';
                } else {
                    console.error("Data profil pelanggan tidak ditemukan.");
                    alert("Error: Data profil tidak ditemukan.");
                }
            } catch (error) {
                console.error("Gagal memuat profil:", error);
                alert("Gagal memuat data profil. Cek koneksi Anda.");
            }
        }

        // --- Muat Riwayat Pesanan ---
        async function loadOrderHistory(uid) {
            const orderListBody = document.getElementById('orderListBody');
            const noOrderMessage = document.getElementById('noOrderMessage');
            orderListBody.innerHTML = ''; // Kosongkan tabel

            try {
                const q = query(
                    collection(db, "new_orders"),
                    where("customerUID", "==", uid),
                    orderBy("orderTime", "desc") // Asumsi ada field orderTime
                );

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noOrderMessage.style.display = 'block';
                    return;
                }
                
                noOrderMessage.style.display = 'none';
                
                querySnapshot.forEach((doc) => {
                    const order = doc.data();
                    const orderId = doc.id;
                    const row = orderListBody.insertRow();
                    
                    const totalCost = order.total ? formatCurrency(order.total) : 'Belum Ditetapkan';

                    row.innerHTML = `
                        <td>${orderId}</td>
                        <td>${order.serviceType || 'Servis Umum'}</td>
                        <td>${new Date(order.orderTime?.seconds * 1000).toLocaleDateString('id-ID') || 'N/A'}</td>
                        <td>${getStatusTag(order.status)}</td>
                        <td>${totalCost}</td>
                        <td><a href="dashboard-customer.html?ticketId=${orderId}" target="_blank" style="color: var(--blue); font-weight: bold; text-decoration: none;">Lihat Detail</a></td>
                    `;
                });

            } catch (error) {
                console.error("Gagal memuat riwayat pesanan:", error);
                // Tampilkan pesan error di tempat tabel
                orderListBody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: ${getComputedStyle(document.documentElement).getPropertyValue('--red')}">Gagal memuat data riwayat.</td></tr>`;
            }
        }

        // =========================================================
        // 3. LOGIKA UI & LOGOUT
        // =========================================================
        
        // Logika Menu Dropdown
        const menuIcon = document.querySelector('.menu-icon');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        menuIcon.addEventListener('click', function(event) {
            event.stopPropagation(); 
            dropdownMenu.classList.toggle('active');
        });

        document.addEventListener('click', function(event) {
            const isClickInsideMenu = dropdownMenu.contains(event.target);
            const isClickOnIcon = menuIcon.contains(event.target);

            if (!isClickInsideMenu && !isClickOnIcon) {
                dropdownMenu.classList.remove('active');
            }
        });

        // Logika Logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                alert("Anda berhasil logout.");
                window.location.href = "index.html";
            } catch (error) {
                console.error("Logout gagal:", error);
                alert("Logout gagal. Coba lagi.");
            }
        });
    </script>
</body>
</html>

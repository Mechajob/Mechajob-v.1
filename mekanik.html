<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mechajob - Dashboard Bengkel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  :root{--orange:#ff9800;--blue:#2a6ed4;--bg:#f4f7f9;--card:#ffffff;--muted:#6b7280;--success:#28a745;--danger:#dc3545;--gold:#FFD700}
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:1200px;margin:20px auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;background:var(--blue);color:#fff;padding:15px 20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}
  header h1{margin:0;font-size:22px;font-weight:bold}
  button{cursor:pointer;border:0;padding:10px 15px;border-radius:8px;font-weight:700;transition:background .2s}
  .btn-ghost{background:#f8fafc;color:#333;border:1px solid #ddd}
  .btn-pro{background:var(--orange);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px}
  .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(10,10,20,0.05);position:relative;margin-bottom:20px}
  .profile-logo{width:80px;height:80px;border-radius:10px;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff}
  .stat-grid{display:flex;gap:10px;margin-top:15px}
  .stat{flex:1;background:#f8fafc;padding:12px;border-radius:8px;text-align:center;border:1px solid #eee}
  .stat .num{font-size:24px;font-weight:800;color:var(--orange)}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid #eee}
  .table{width:100%;border-collapse:collapse;margin-top:10px}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .table th{background:var(--blue);color:#fff;text-transform:uppercase;font-size:12px}
  .table tbody tr:hover{background:#f7f7f7}
  .status{padding:6px 10px;border-radius:999px;font-weight:700;color:#fff;font-size:12px}
  .status.wait{background:var(--orange)}.status.available{background:var(--success)}
  .status.in-progress{background:var(--blue)}.status.selesai{background:var(--success)}
  .status.pro{background:var(--gold);color:#111}.status.danger{background:var(--danger)}
  .mini{padding:6px 10px;font-size:13px;background:var(--orange);color:white}
  .mini-finish{background:var(--success);color:white}
  .mini-lunas{background:#1e7e34;color:white}
  .locked-overlay{position:absolute;inset:0;background:rgba(255,255,255,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:10px;text-align:center;backdrop-filter:blur(3px)}
  .profile-actions{display:flex;flex-direction:column;gap:10px;margin-top:20px;padding-top:20px;border-top:1px solid #eee}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1><i class="fas fa-tachometer-alt"></i> Mechajob — Dashboard Bengkel</h1>
      <div class="muted" id="headerInfo">Memuat status akun...</div>
    </div>
    <button class="btn-ghost" id="btnLogout">Logout</button>
  </header>

  <div class="grid">
    <aside>
      <div class="card">
        <div style="display:flex;gap:15px;align-items:center">
          <div class="profile-logo"><i class="fas fa-tools"></i></div>
          <div>
            <div style="font-weight:800;font-size:16px" id="shopName">Memuat...</div>
            <div class="muted" id="shopAddr">Memuat...</div>
            <div style="margin-top:6px" class="muted"><i class="fab fa-whatsapp"></i> WA: <span id="shopWA">Memuat...</span></div>
            <div style="margin-top:8px" id="shopStatusContainer"></div>
            <div style="margin-top:8px;font-size:14px" id="shopRating">Rating: Belum ada</div>
          </div>
        </div>

        <div style="margin-top:20px" class="section-title"><strong><i class="fas fa-chart-bar"></i> Ringkasan Kinerja</strong></div>
        <div class="stat-grid">
          <div class="stat"><div class="num" id="statWaiting">0</div><div class="muted">Pesanan Baru</div></div>
          <div class="stat"><div class="num" id="statTaken">0</div><div class="muted">Order Aktif</div></div>
          <div class="stat"><div class="num" id="statRevenue">Rp 0</div><div class="muted">Omzet Lunas</div></div>
        </div>

        <div class="profile-actions">
          <button class="btn-ghost" id="btnEditProfile">Edit Profil</button>
          <button class="btn-pro" id="btnUpgrade">Upgrade ke PRO</button>
          <button class="btn-danger" id="btnLogout2">Logout</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="card">
        <div class="section-title">
          <strong><i class="fas fa-car-side"></i> Pesanan Baru</strong>
          <div class="muted" id="orderLimitInfo">Memuat batas order...</div>
        </div>
        <table class="table">
          <thead><tr><th>ID</th><th>Nama</th><th>Kendaraan</th><th>Keluhan</th><th>Lokasi</th><th>Aksi</th></tr></thead>
          <tbody id="tblCustomers"><tr><td colspan="6">Memuat...</td></tr></tbody>
        </table>
      </div>

      <div class="card">
        <div class="section-title"><strong><i class="fas fa-receipt"></i> Orderan Saya</strong></div>
        <table class="table">
          <thead><tr><th>ID</th><th>Pelanggan</th><th>WA</th><th>Layanan</th><th>Status</th><th>Bayar</th><th>Total</th><th>Aksi</th></tr></thead>
          <tbody id="tblOrders"><tr><td colspan="8">Memuat...</td></tr></tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, query, where, onSnapshot, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyB_pygYC3UubxRWZScPO-GveCi8jh_zkdc", authDomain: "mechajob-b7360.firebaseapp.com", projectId: "mechajob-b7360", storageBucket: "mechajob-b7360.firebasestorage.app", messagingSenderId: "753002885541", appId: "1:753002885541:web:96e4964dbd300193ff384c" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid = null;
const STATE = { shop: {}, customers: [], myOrders: [] };

// GANTI DENGAN SERVER KEY MIDTRANS ANDA (hanya dipakai di server-side sebenarnya, tapi untuk demo bisa langsung)
const MIDTRANS_CLIENT_KEY = "SB-Mid-client-xxxxxxxxxxxxxxxx"; // Ganti dengan Client Key Anda (bisa sandbox)
const MIDTRANS_SERVER_KEY = "SB-Mid-server-xxxxxxxxxxxxxxxx"; // Untuk generate token (harus di Cloud Function sebenarnya)

function formatCurrency(n) { return n ? n.toLocaleString('id-ID') : '0'; }

// === GENERATE SNAP TOKEN (DEMO LANGSUNG DI CLIENT - UNTUK PRODUKSI HARUS DI CLOUD FUNCTION ===
async function generateSnapToken(orderId, total, custName, custWA) {
  const response = await fetch('https://app.sandbox.midtrans.com/snap/v1/transactions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Basic ' + btoa(MIDTRANS_SERVER_KEY + ':')
    },
    body: JSON.stringify({
      transaction_details: { order_id: orderId, gross_amount: total },
      customer_details: { first_name: custName, phone: custWA?.replace(/^0/, '62') },
      item_details: [{ id: "SERVICE", price: total, quantity: 1, name: "Jasa Servis Mechajob" }],
      enabled_payments: ["gopay","shopeepay","qris","bank_transfer","credit_card","indomaret","alfamart"]
    })
  });
  const data = await response.json();
  return data.token;
}

// === FUNGSI UTAMA ===
async function finishOrder(id) {
  const totalStr = prompt("Masukkan total biaya (hanya angka):");
  if (!totalStr) return;
  const total = parseInt(totalStr);
  if (isNaN(total) || total <= 0) return alert("Biaya tidak valid");

  if (!confirm(`Set total Rp ${formatCurrency(total)} dan aktifkan pembayaran online?`)) return;

  try {
    // 1. Generate Snap Token
    const orderDoc = await getDoc(doc(db, "new_orders", id));
    const orderData = orderDoc.data();
    const snapToken = await generateSnapToken(id, total, orderData.custName, orderData.custWA);

    // 2. Simpan ke Firestore
    await updateDoc(doc(db, "new_orders", id), {
      status: "selesai",
      total: total,
      paymentStatus: null,
      snapToken: snapToken,
      finishTime: serverTimestamp()
    });

    alert(`Order selesai! Total Rp ${formatCurrency(total)}\nPelanggan bisa bayar via QRIS, Transfer, E-Wallet, Kartu, dll.`);
  } catch (e) {
    console.error(e);
    alert("Gagal generate pembayaran. Pastikan Server Key Midtrans benar.");
  }
}

window.claimOrder = async (id) => {
  if (!uid) return alert("Login dulu");
  const active = STATE.myOrders.filter(o => o.status === 'in-progress').length;
  if (!STATE.shop.isPro && active >= 10) return alert("Batas 10 order aktif (upgrade ke PRO)");

  if (!confirm("Ambil order ini?")) return;

  try {
    await runTransaction(db, async (transaction) => {
      const ref = doc(db, "new_orders", id);
      const snap = await transaction.get(ref);
      if (!snap.exists() || snap.data().status !== "pending") throw "Sudah diambil orang lain";
      transaction.update(ref, {
        status: "in-progress",
        mekanikId: uid,
        mekanikName: STATE.shop.name,
        claimTime: serverTimestamp()
      });
    });
    alert("Order berhasil diambil!");
  } catch (e) {
    alert("Gagal: " + e);
  }
};

window.confirmPayment = async (id) => {
  if (confirm("Konfirmasi pembayaran LUNAS?")) {
    await updateDoc(doc(db, "new_orders", id), {
      paymentStatus: "lunas",
      paidTime: serverTimestamp()
    });
    alert("Status LUNAS!");
  }
};

// === RENDER SEMUA ===
function render() {
  document.getElementById("headerInfo").textContent = `\( {auth.currentUser?.email} • \){STATE.shop.isPro ? "PRO" : "STANDAR"}`;
  document.getElementById("shopName").textContent = STATE.shop.name || "Bengkel";
  document.getElementById("shopAddr").textContent = STATE.shop.address || "-";
  document.getElementById("shopWA").textContent = STATE.shop.wa || "-";
  document.getElementById("shopStatusContainer").innerHTML = `<span class="status \( {STATE.shop.isPro?'pro':'wait'}"> \){STATE.shop.isPro?'PRO':'STANDAR'}</span>`;

  const revenue = STATE.myOrders.filter(o => o.paymentStatus === 'lunas').reduce((s,o)=>s+(o.total||0),0);
  document.getElementById("statRevenue").textContent = `Rp ${formatCurrency(revenue)}`;
  document.getElementById("statWaiting").textContent = STATE.customers.length;
  document.getElementById("statTaken").textContent = STATE.myOrders.filter(o=>o.status==='in-progress').length;

  // Tabel Pesanan Baru
  const tbody1 = document.getElementById("tblCustomers");
  tbody1.innerHTML = STATE.customers.length === 0 ? "<tr><td colspan='6' style='text-align:center'>Tidak ada pesanan baru</td></tr>" : "";
  STATE.customers.forEach(c => {
    tbody1.innerHTML += `<tr>
      <td>\( {c.id.slice(0,8)}</td><td> \){c.custName}</td><td>\( {c.vehicle}</td><td> \){c.issue}</td><td>${c.location}</td>
      <td><button class="mini" onclick="window.claimOrder('${c.id}')">Ambil</button></td>
    </tr>`;
  });

  // Tabel Orderan Saya
  const tbody2 = document.getElementById("tblOrders");
  tbody2.innerHTML = "";
  if (STATE.myOrders.length === 0) {
    tbody2.innerHTML = "<tr><td colspan='8' style='text-align:center'>Belum ada order</td></tr>";
  } else {
    STATE.myOrders.forEach(o => {
      const payStatus = o.paymentStatus === 'lunas' ? `<span class="status selesai">LUNAS</span>` :
                       o.paymentStatus === 'menunggu_konfirmasi' ? `<button class="mini mini-lunas" onclick="window.confirmPayment('${o.id}')">Konfirmasi LUNAS</button>` :
                       `<span class="status danger">BELUM</span>`;
      const action = o.status === 'in-progress' ? `<button class="mini mini-finish" onclick="window.finishOrder('${o.id}')">Set Biaya</button>` :
                     o.status === 'selesai' && !o.paymentStatus ? `<button class="mini mini-finish" onclick="window.finishOrder('${o.id}')">Set Biaya</button>` :
                     `<button disabled>Selesai</button>`;
      const total = o.total ? `Rp ${formatCurrency(o.total)}` : '-';

      tbody2.innerHTML += `<tr>
        <td>${o.id.slice(0,8)}</td>
        <td>${o.custName}</td>
        <td><a href="https://wa.me/\( {o.custWA?.replace(/^0/,'62')}" target="_blank"> \){o.custWA||'-'}</a></td>
        <td>${o.issue}</td>
        <td><span class="status \( {o.status}"> \){o.status === 'in-progress' ? 'Dikerjakan' : 'Selesai'}</span></td>
        <td>${payStatus}</td>
        <td>${total}</td>
        <td>${action}</td>
      </tr>`;
    });
  }
}

// === LISTENER FIREBASE ===
onAuthStateChanged(auth, async (user) => {
  if (!user) { location.href = "login.html"; return; }
  uid = user.uid;

  // Profil Bengkel
  const profileSnap = await getDoc(doc(db, "mekanik_users", uid));
  STATE.shop = profileSnap.exists() ? profileSnap.data() : { name: "Bengkel Baru", wa: "08xx", address: "-", isPro: false };

  // Pesanan Baru
  onSnapshot(query(collection(db, "new_orders"), where("status", "==", "pending")), snap => {
    STATE.customers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  });

  // Orderan Saya
  onSnapshot(query(collection(db, "new_orders"), where("mekanikId", "==", uid)), snap => {
    STATE.myOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  });

  render();
});

// Logout
document.querySelectorAll("#btnLogout, #btnLogout2").forEach(b => b.onclick = () => signOut(auth));
</script>
</body>
</html>
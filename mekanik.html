<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mechajob Standar - Dashboard Bengkel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  /* --- 1. VARIABEL CSS --- */
  :root{
    --orange:#ff9800; 
    --blue:#2a6ed4; 
    --bg:#f4f7f9; 
    --card:#ffffff;
    --muted:#6b7280; 
    --success:#28a745; 
    --danger:#dc3545;
    --gold: #FFD700; /* Untuk status PRO */
  }
  
  /* --- 2. GAYA GLOBAL & UTAMA --- */
  *{box-sizing:border-box}
  body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  .wrap{max-width:1200px;margin:20px auto;padding:16px}
  
  /* --- 3. HEADER & TOMBOL --- */
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--blue);
    color:#fff;
    padding:15px 20px;
    border-radius:10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  header h1{margin:0;font-size:22px;font-weight: bold;}
  button{cursor:pointer;border:0;padding:10px 15px;border-radius:8px;font-weight:700;transition: background 0.2s;}
  .btn-ghost{background: #f8fafc;color: #333;border:1px solid #ddd;}
  .btn-ghost:hover{background:#eee;}
  .btn-pro{background:var(--orange);color:#fff}
  .btn-pro:hover{background:#f57c00;}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-danger:hover{background:#c82333;}
  .btn-upgrade{background:var(--danger);color:#fff}
  .btn-upgrade:hover{background:#c82333;}
  
  /* --- 4. LAYOUT GRID & KARTU --- */
  .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px}
  .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(10,10,20,0.05);position:relative;margin-bottom:20px;}
  
  /* --- 5. DETAIL PROFIL & STATISTIK --- */
  .profile-logo{width:80px;height:80px;border-radius:10px;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;box-shadow: 0 0 10px rgba(0,0,0,0.1);}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:#333}
  .stat-grid{display:flex;gap:10px;margin-top:15px}
  .stat{flex:1;background:#f8fafc;padding:12px;border-radius:8px;text-align:center;border:1px solid #eee;}
  .stat .num{font-size:24px;font-weight:800;color:var(--orange)}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid #eee;}
  
  /* --- 6. TABEL DAN STATUS --- */
  .table{width:100%;border-collapse:collapse;margin-top:10px;}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .table th{background:var(--blue);color:#fff;text-transform:uppercase;font-size:12px}
  .table tbody tr:last-child td { border-bottom: none; }
  .table tbody tr:hover { background-color: #f7f7f7; }
  
  .status{padding:6px 10px;border-radius:999px;font-weight:700;color:#fff;font-size:12px}
  .status.wait{background:var(--orange)}
  .status.available{background:var(--success)}
  .status.in-progress{background:var(--blue)}
  .status.selesai{background:var(--success)}
  .status.pro{background:var(--gold); color:#111;}
  
  .mini{padding:6px 10px;font-size:13px;background:var(--orange);color:white;border:1px solid var(--orange);}
  .mini:hover{background:#f57c00;}
  .mini-finish{background:var(--success); color: white;}
  .mini-finish:hover{background:#1e7e34;}

  /* --- 7. OVERLAY & LOCK --- */
  .locked-overlay{
    position:absolute;inset:0;background:rgba(255,255,255,0.9);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    border-radius:10px;text-align:center;backdrop-filter:blur(3px);
  }
  .locked-overlay .lock-icon {
      font-size: 40px;
      color: var(--muted);
      margin-bottom: 10px;
  }
  .profile-actions{
    display:flex;
    flex-direction:column;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }
  
  /* --- 8. RESPONSIVE --- */
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; gap: 15px;}
    .wrap {padding: 10px;}
    header h1 { font-size: 18px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1><i class="fas fa-tachometer-alt"></i> Mechajob â€” Dashboard Bengkel</h1>
      <div class="muted" id="headerInfo">Memuat status akun...</div> 
    </div>
    <button class="btn-ghost" id="btnLogoutHeader">ðŸšª Logout</button>
  </header>

  <div class="grid">
    <aside>
      <div class="card">
        <div style="display:flex;gap:15px;align-items:center">
          <div class="profile-logo"><i class="fas fa-tools"></i></div>
          <div>
            <div style="font-weight:800; font-size: 16px;" id="shopName">Memuat Nama Bengkel...</div>
            <div class="muted" id="shopAddr">Memuat Alamat...</div>
            <div style="margin-top:6px" class="muted"><i class="fab fa-whatsapp"></i> WA: <span id="shopWA">Memuat...</span></div>
            <div style="margin-top:8px" id="shopStatusContainer"><span class="status wait">STANDAR</span></div>
          </div>
        </div>

        <div style="margin-top:20px" class="section-title">
          <strong><i class="fas fa-chart-bar"></i> Ringkasan Kinerja</strong>
        </div>
        <div class="stat-grid">
          <div class="stat"><div class="num" id="statWaiting">0</div><div class="muted">Pesanan Baru</div></div>
          <div class="stat"><div class="num" id="statTaken">0</div><div class="muted">Order Aktif</div></div>
          <div class="stat"><div class="num" id="statRevenue">Rp 0</div><div class="muted">Omzet Selesai</div></div>
        </div>
        
        <div class="profile-actions">
            <button class="btn-ghost" id="btnEditProfile"><i class="fas fa-cog"></i> Edit Profil</button>
            <button class="btn-pro" id="btnUpgrade"><i class="fas fa-crown"></i> Upgrade ke PRO</button>
            <button class="btn-danger" id="btnLogoutFooter"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="card">
        <div class="section-title">
          <strong><i class="fas fa-car-side"></i> Pesanan Baru Tersedia</strong>
          <div class="muted" id="orderLimitInfo">Memuat batas order...</div>
        </div>
        <table class="table">
          <thead><tr><th>ID</th><th>Nama</th><th>Kendaraan</th><th>Keluhan</th><th>Lokasi</th><th>Aksi</th></tr></thead>
          <tbody id="tblCustomers">
            <tr><td colspan="6">Memuat pesanan baru dari server...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="min-height: 180px;">
        <div class="section-title">
          <strong><i class="fas fa-cogs"></i> Sparepart Dicari Pelanggan</strong>
        </div>
        <div class="locked-overlay" id="sparepartLock">
          <div class="lock-icon"><i class="fas fa-lock"></i></div>
          <div>ðŸ”’ Fitur ini **terkunci**<br><small>Upgrade ke PRO untuk mengakses pencarian sparepart pelanggan</small></div>
          <button class="btn-upgrade" style="margin-top:15px" id="btnUpgrade2"><i class="fas fa-bolt"></i> Upgrade ke PRO Sekarang</button>
        </div>
        <div id="sparepartContent">
          </div>
      </div>

      <div class="card">
        <div class="section-title"><strong><i class="fas fa-receipt"></i> Orderan Saya</strong></div>
        <table class="table">
          <thead><tr><th>ID</th><th>Pelanggan</th><th>Layanan</th><th>Status</th><th>Total</th><th>Aksi</th></tr></thead>
          <tbody id="tblOrders">
             <tr><td colspan="6">Memuat orderan aktif...</td></tr>
        </tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<script type="module">
// =========================================================
// 1. KONFIGURASI DAN IMPOR FIREBASE
// =========================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    getDoc, 
    updateDoc,
    collection, 
    query, 
    where, 
    onSnapshot,
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"; 

const firebaseConfig = {
    apiKey: "AIzaSyB_pygYC3UubxRWZScPO-GveCi8jh_zkdc",
    authDomain: "mechajob-b7360.firebaseapp.com",
    projectId: "mechajob-b7360",
    storageBucket: "mechajob-b7360.firebasestorage.app",
    messagingSenderId: "753002885541",
    appId: "1:753002885541:web:96e4964dbd300193ff384c",
    measurementId: "G-ZY3RS8WGP7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = null;
let currentUserEmail = null; 

// =========================================================
// 2. STATE APLIKASI
// =========================================================
const STATE = {
  shop: { name: "Memuat...", address: "Memuat...", wa: "Memuat...", isPro: false, limit: 10 },
  customers: [], // Pesanan Baru Tersedia (status: pending)
  myOrders: [],  // Orderan Saya (mekanikId: currentUserId)
};

// =========================================================
// 3. FUNGSI RENDER UTAMA
// =========================================================
function formatCurrency(number) {
    if (number === 0 || number === undefined) return '0';
    // Gunakan toLocaleString untuk format Indonesia
    return number.toLocaleString('id-ID');
}

function render(){
  
  // 3a. Update Header Info
  const shopStatusText = STATE.shop.isPro ? 'PRO' : 'STANDAR';
  const shopStatusClass = STATE.shop.isPro ? 'pro' : 'wait';
  
  document.getElementById('headerInfo').innerHTML = `<i class="fas fa-user-circle"></i> ${currentUserEmail || 'Memuat...'} â€¢ Akun ${shopStatusText}`;
  
  // 3b. Update Profil & Status
  document.getElementById("shopName").textContent = STATE.shop.name;
  document.getElementById("shopAddr").textContent = STATE.shop.address;
  document.getElementById("shopWA").textContent = STATE.shop.wa;
  document.getElementById("shopStatusContainer").innerHTML = `<span class="status ${shopStatusClass}">${shopStatusText}</span>`;
  
  
  // 3c. Update Ringkasan Stat
  const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in-progress').length;
  const totalRevenue = STATE.myOrders
    .filter(o => o.status === 'selesai' && o.total)
    .reduce((sum, o) => sum + o.total, 0);
    
  document.getElementById("statWaiting").textContent = STATE.customers.length;
  document.getElementById("statTaken").textContent = currentOrdersInProgress; 
  document.getElementById("statRevenue").textContent = `Rp ${formatCurrency(totalRevenue)}`;
  
  document.getElementById("orderLimitInfo").textContent = STATE.shop.isPro 
    ? 'Batas Akun PRO: Tidak ada batasan jumlah order aktif.'
    : `Batas Akun Standar: Ambil maks. ${STATE.shop.limit} order aktif.`;

  // 3d. Render Pesanan Baru (customers)
  const ctbody=document.getElementById("tblCustomers");
  ctbody.innerHTML="";
  if (STATE.customers.length === 0) {
      ctbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada pesanan baru saat ini.</td></tr>';
  } else {
      STATE.customers.forEach(c=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
          <td>${c.id.substring(0, 6)}...</td><td>${c.name}</td><td>${c.vehicle}</td><td>${c.issue}</td><td>${c.location}</td>
          <td><button class="mini" onclick="window.claimOrder('${c.id}')">Ambil</button></td>`;
          ctbody.appendChild(tr);
      });
  }
  
  // 3e. Render Orderan Saya (myOrders)
  const otbody=document.getElementById("tblOrders");
  otbody.innerHTML="";
  if (STATE.myOrders.length === 0) {
      otbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Anda belum mengambil orderan.</td></tr>';
  } else {
      STATE.myOrders.forEach(o=>{
          const statusClass = o.status.toLowerCase().replace('-', ''); 
          let statusText = o.status.charAt(0).toUpperCase() + o.status.slice(1).replace('-', ' ');
          const totalDisplay = o.status === 'selesai' ? `Rp ${formatCurrency(o.total)}` : 'Belum selesai';
          
          const actionButton = o.status === 'in-progress' 
                               ? `<button class="mini mini-finish" onclick="window.finishOrder('${o.id}')">Selesaikan</button>`
                               : `<button class="btn-ghost" disabled>Selesai</button>`;

          const tr=document.createElement("tr");
          tr.innerHTML=`
          <td>${o.id.substring(0, 6)}...</td>
          <td>${o.cust}</td>
          <td>${o.service}</td>
          <td><span class="status ${statusClass}">${statusText}</span></td>
          <td>${totalDisplay}</td>
          <td>${actionButton}</td>`;
          otbody.appendChild(tr);
      });
  }
  
  // 3f. Kontrol Fitur PRO (Locked Overlay)
  const lockOverlay = document.getElementById('sparepartLock');
  if (lockOverlay) {
      lockOverlay.style.display = STATE.shop.isPro ? 'none' : 'flex';
  }
}

// =========================================================
// 4. LOGIKA FIREBASE LISTENERS & FETCH
// =========================================================

async function fetchAndRenderProfile(uid) {
    try {
        const docRef = doc(db, "mekanik_users", uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            STATE.shop = {
                name: data.shopName || "Nama Bengkel Belum Disetel",
                address: data.shopAddress || "Alamat Belum Disetel",
                wa: data.shopWA || "WA Belum Disetel",
                isPro: data.isPro || false,
                limit: data.isPro ? 999 : 10 // Batas order aktif untuk akun Standar
            };
            // Setel alamat menjadi ringkasan yang lebih singkat jika terlalu panjang
            STATE.shop.address = STATE.shop.address.substring(0, 40) + '...';
            render();
        } else {
            console.warn("Profil mekanik tidak ditemukan.");
            // Logika untuk membuat profil dasar jika belum ada bisa ditambahkan di sini
        }
    } catch (error) {
        console.error("Gagal memuat profil:", error);
    }
}

// Mendengarkan Pesanan BARU (status: pending) secara Realtime
function setupRealtimeNewOrderListener() {
    const ordersRef = collection(db, "new_orders");
    const q = query(ordersRef, where("status", "==", "pending"));

    onSnapshot(q, (snapshot) => {
        STATE.customers = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id, 
                name: data.custName,
                vehicle: data.vehicle || `${data.vehicleType} ${data.vehicleModel}`,
                issue: data.issueType || data.issueDesc, 
                location: data.custLocation,
            };
        });
        render(); 
    }, (error) => {
        console.error("Gagal mendengarkan pesanan baru:", error);
    });
}

// Mendengarkan Orderan SAYA (mekanikId: currentUserId) secara Realtime
function setupRealtimeMyOrderListener(uid) {
    const ordersRef = collection(db, "new_orders");
    const q = query(ordersRef, where("mekanikId", "==", uid));

    onSnapshot(q, (snapshot) => {
        STATE.myOrders = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id, 
                cust: data.custName,
                service: data.issueType || data.issueDesc,
                status: data.status,
                total: data.total || 0 
            };
        });
        render(); 
    }, (error) => {
        console.error("Gagal mendengarkan orderan saya:", error);
    });
}

// =========================================================
// 5. FUNGSI LOGIKA (Update Firestore)
// =========================================================

window.claimOrder = async function(id){
  const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in
  }
  header h1{margin:0;font-size:22px;font-weight: bold;}
  button{cursor:pointer;border:0;padding:10px 15px;border-radius:8px;font-weight:700;transition: background 0.2s;}
  .btn-ghost{background: #f8fafc;color: #333;border:1px solid #ddd;}
  .btn-ghost:hover{background:#eee;}
  .btn-pro{background:var(--orange);color:#fff}
  .btn-pro:hover{background:#f57c00;}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-danger:hover{background:#c82333;}
  .btn-upgrade{background:var(--danger);color:#fff}
  .btn-upgrade:hover{background:#c82333;}
  
  /* --- 4. LAYOUT GRID & KARTU --- */
  .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px}
  .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(10,10,20,0.05);position:relative;margin-bottom:20px;}
  
  /* --- 5. DETAIL PROFIL & STATISTIK --- */
  .profile-logo{width:80px;height:80px;border-radius:10px;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:36px;color:#fff;box-shadow: 0 0 10px rgba(0,0,0,0.1);}
  .muted{color:var(--muted);font-size:13px}
  .small{font-size:13px;color:#333}
  .stat-grid{display:flex;gap:10px;margin-top:15px}
  .stat{flex:1;background:#f8fafc;padding:12px;border-radius:8px;text-align:center;border:1px solid #eee;}
  .stat .num{font-size:24px;font-weight:800;color:var(--orange)}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:5px;border-bottom:1px solid #eee;}
  
  /* --- 6. TABEL DAN STATUS --- */
  .table{width:100%;border-collapse:collapse;margin-top:10px;}
  .table th,.table td{padding:10px 12px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .table th{background:var(--blue);color:#fff;text-transform:uppercase;font-size:12px}
  .table tbody tr:last-child td { border-bottom: none; }
  .table tbody tr:hover { background-color: #f7f7f7; }
  
  .status{padding:6px 10px;border-radius:999px;font-weight:700;color:#fff;font-size:12px}
  .status.wait{background:var(--orange)}
  .status.available{background:var(--success)}
  .status.in-progress{background:var(--blue)}
  .status.selesai{background:var(--success)}
  .status.pro{background:var(--gold); color:#111;}
  
  .mini{padding:6px 10px;font-size:13px;background:var(--orange);color:white;border:1px solid var(--orange);}
  .mini:hover{background:#f57c00;}
  .mini-finish{background:var(--success); color: white;}
  .mini-finish:hover{background:#1e7e34;}

  /* --- 7. OVERLAY & LOCK --- */
  .locked-overlay{
    position:absolute;inset:0;background:rgba(255,255,255,0.9);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    border-radius:10px;text-align:center;backdrop-filter:blur(3px);
  }
  .locked-overlay .lock-icon {
      font-size: 40px;
      color: var(--muted);
      margin-bottom: 10px;
  }
  .profile-actions{
    display:flex;
    flex-direction:column;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }
  
  /* --- 8. RESPONSIVE --- */
  @media(max-width:980px){
    .grid{grid-template-columns:1fr; gap: 15px;}
    .wrap {padding: 10px;}
    header h1 { font-size: 18px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1><i class="fas fa-tachometer-alt"></i> Mechajob â€” Dashboard Bengkel</h1>
      <div class="muted" id="headerInfo">Memuat status akun...</div> 
    </div>
    <button class="btn-ghost" id="btnLogoutHeader">ðŸšª Logout</button>
  </header>

  <div class="grid">
    <aside>
      <div class="card">
        <div style="display:flex;gap:15px;align-items:center">
          <div class="profile-logo"><i class="fas fa-tools"></i></div>
          <div>
            <div style="font-weight:800; font-size: 16px;" id="shopName">Memuat Nama Bengkel...</div>
            <div class="muted" id="shopAddr">Memuat Alamat...</div>
            <div style="margin-top:6px" class="muted"><i class="fab fa-whatsapp"></i> WA: <span id="shopWA">Memuat...</span></div>
            <div style="margin-top:8px" id="shopStatusContainer"><span class="status wait">STANDAR</span></div>
          </div>
        </div>

        <div style="margin-top:20px" class="section-title">
          <strong><i class="fas fa-chart-bar"></i> Ringkasan Kinerja</strong>
        </div>
        <div class="stat-grid">
          <div class="stat"><div class="num" id="statWaiting">0</div><div class="muted">Pesanan Baru</div></div>
          <div class="stat"><div class="num" id="statTaken">0</div><div class="muted">Order Aktif</div></div>
          <div class="stat"><div class="num" id="statRevenue">Rp 0</div><div class="muted">Omzet Selesai</div></div>
        </div>
        
        <div class="profile-actions">
            <button class="btn-ghost" id="btnEditProfile"><i class="fas fa-cog"></i> Edit Profil</button>
            <button class="btn-pro" id="btnUpgrade"><i class="fas fa-crown"></i> Upgrade ke PRO</button>
            <button class="btn-danger" id="btnLogoutFooter"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
      </div>
    </aside>

    <main>
      <div class="card">
        <div class="section-title">
          <strong><i class="fas fa-car-side"></i> Pesanan Baru Tersedia</strong>
          <div class="muted" id="orderLimitInfo">Memuat batas order...</div>
        </div>
        <table class="table">
          <thead><tr><th>ID</th><th>Nama</th><th>Kendaraan</th><th>Keluhan</th><th>Lokasi</th><th>Aksi</th></tr></thead>
          <tbody id="tblCustomers">
            <tr><td colspan="6">Memuat pesanan baru dari server...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="card" style="min-height: 180px;">
        <div class="section-title">
          <strong><i class="fas fa-cogs"></i> Sparepart Dicari Pelanggan</strong>
        </div>
        <div class="locked-overlay" id="sparepartLock">
          <div class="lock-icon"><i class="fas fa-lock"></i></div>
          <div>ðŸ”’ Fitur ini **terkunci**<br><small>Upgrade ke PRO untuk mengakses pencarian sparepart pelanggan</small></div>
          <button class="btn-upgrade" style="margin-top:15px" id="btnUpgrade2"><i class="fas fa-bolt"></i> Upgrade ke PRO Sekarang</button>
        </div>
        <div id="sparepartContent">
          </div>
      </div>

      <div class="card">
        <div class="section-title"><strong><i class="fas fa-receipt"></i> Orderan Saya</strong></div>
        <table class="table">
          <thead><tr><th>ID</th><th>Pelanggan</th><th>Layanan</th><th>Status</th><th>Total</th><th>Aksi</th></tr></thead>
          <tbody id="tblOrders">
             <tr><td colspan="6">Memuat orderan aktif...</td></tr>
        </tbody>
        </table>
      </div>
    </main>
  </div>
</div>

<script type="module">
// =========================================================
// 1. KONFIGURASI DAN IMPOR FIREBASE
// =========================================================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged, 
    signOut 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { 
    getFirestore, 
    doc, 
    getDoc, 
    updateDoc,
    collection, 
    query, 
    where, 
    onSnapshot,
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"; 

const firebaseConfig = {
    apiKey: "AIzaSyB_pygYC3UubxRWZScPO-GveCi8jh_zkdc",
    authDomain: "mechajob-b7360.firebaseapp.com",
    projectId: "mechajob-b7360",
    storageBucket: "mechajob-b7360.firebasestorage.app",
    messagingSenderId: "753002885541",
    appId: "1:753002885541:web:96e4964dbd300193ff384c",
    measurementId: "G-ZY3RS8WGP7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = null;
let currentUserEmail = null; 

// =========================================================
// 2. STATE APLIKASI
// =========================================================
const STATE = {
  shop: { name: "Memuat...", address: "Memuat...", wa: "Memuat...", isPro: false, limit: 10 },
  customers: [], // Pesanan Baru Tersedia (status: pending)
  myOrders: [],  // Orderan Saya (mekanikId: currentUserId)
};

// =========================================================
// 3. FUNGSI RENDER UTAMA
// =========================================================
function formatCurrency(number) {
    if (number === 0 || number === undefined) return '0';
    // Gunakan toLocaleString untuk format Indonesia
    return number.toLocaleString('id-ID');
}

function render(){
  
  // 3a. Update Header Info
  const shopStatusText = STATE.shop.isPro ? 'PRO' : 'STANDAR';
  const shopStatusClass = STATE.shop.isPro ? 'pro' : 'wait';
  
  document.getElementById('headerInfo').innerHTML = `<i class="fas fa-user-circle"></i> ${currentUserEmail || 'Memuat...'} â€¢ Akun ${shopStatusText}`;
  
  // 3b. Update Profil & Status
  document.getElementById("shopName").textContent = STATE.shop.name;
  document.getElementById("shopAddr").textContent = STATE.shop.address;
  document.getElementById("shopWA").textContent = STATE.shop.wa;
  document.getElementById("shopStatusContainer").innerHTML = `<span class="status ${shopStatusClass}">${shopStatusText}</span>`;
  
  
  // 3c. Update Ringkasan Stat
  const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in-progress').length;
  const totalRevenue = STATE.myOrders
    .filter(o => o.status === 'selesai' && o.total)
    .reduce((sum, o) => sum + o.total, 0);
    
  document.getElementById("statWaiting").textContent = STATE.customers.length;
  document.getElementById("statTaken").textContent = currentOrdersInProgress; 
  document.getElementById("statRevenue").textContent = `Rp ${formatCurrency(totalRevenue)}`;
  
  document.getElementById("orderLimitInfo").textContent = STATE.shop.isPro 
    ? 'Batas Akun PRO: Tidak ada batasan jumlah order aktif.'
    : `Batas Akun Standar: Ambil maks. ${STATE.shop.limit} order aktif.`;

  // 3d. Render Pesanan Baru (customers)
  const ctbody=document.getElementById("tblCustomers");
  ctbody.innerHTML="";
  if (STATE.customers.length === 0) {
      ctbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada pesanan baru saat ini.</td></tr>';
  } else {
      STATE.customers.forEach(c=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`
          <td>${c.id.substring(0, 6)}...</td><td>${c.name}</td><td>${c.vehicle}</td><td>${c.issue}</td><td>${c.location}</td>
          <td><button class="mini" onclick="window.claimOrder('${c.id}')">Ambil</button></td>`;
          ctbody.appendChild(tr);
      });
  }
  
  // 3e. Render Orderan Saya (myOrders)
  const otbody=document.getElementById("tblOrders");
  otbody.innerHTML="";
  if (STATE.myOrders.length === 0) {
      otbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Anda belum mengambil orderan.</td></tr>';
  } else {
      STATE.myOrders.forEach(o=>{
          const statusClass = o.status.toLowerCase().replace('-', ''); 
          let statusText = o.status.charAt(0).toUpperCase() + o.status.slice(1).replace('-', ' ');
          const totalDisplay = o.status === 'selesai' ? `Rp ${formatCurrency(o.total)}` : 'Belum selesai';
          
          const actionButton = o.status === 'in-progress' 
                               ? `<button class="mini mini-finish" onclick="window.finishOrder('${o.id}')">Selesaikan</button>`
                               : `<button class="btn-ghost" disabled>Selesai</button>`;

          const tr=document.createElement("tr");
          tr.innerHTML=`
          <td>${o.id.substring(0, 6)}...</td>
          <td>${o.cust}</td>
          <td>${o.service}</td>
          <td><span class="status ${statusClass}">${statusText}</span></td>
          <td>${totalDisplay}</td>
          <td>${actionButton}</td>`;
          otbody.appendChild(tr);
      });
  }
  
  // 3f. Kontrol Fitur PRO (Locked Overlay)
  const lockOverlay = document.getElementById('sparepartLock');
  if (lockOverlay) {
      lockOverlay.style.display = STATE.shop.isPro ? 'none' : 'flex';
  }
}

// =========================================================
// 4. LOGIKA FIREBASE LISTENERS & FETCH
// =========================================================

async function fetchAndRenderProfile(uid) {
    try {
        const docRef = doc(db, "mekanik_users", uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            STATE.shop = {
                name: data.shopName || "Nama Bengkel Belum Disetel",
                address: data.shopAddress || "Alamat Belum Disetel",
                wa: data.shopWA || "WA Belum Disetel",
                isPro: data.isPro || false,
                limit: data.isPro ? 999 : 10 // Batas order aktif untuk akun Standar
            };
            // Setel alamat menjadi ringkasan yang lebih singkat jika terlalu panjang
            STATE.shop.address = STATE.shop.address.substring(0, 40) + '...';
            render();
        } else {
            console.warn("Profil mekanik tidak ditemukan.");
            // Logika untuk membuat profil dasar jika belum ada bisa ditambahkan di sini
        }
    } catch (error) {
        console.error("Gagal memuat profil:", error);
    }
}

// Mendengarkan Pesanan BARU (status: pending) secara Realtime
function setupRealtimeNewOrderListener() {
    const ordersRef = collection(db, "new_orders");
    const q = query(ordersRef, where("status", "==", "pending"));

    onSnapshot(q, (snapshot) => {
        STATE.customers = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id, 
                name: data.custName,
                vehicle: data.vehicle || `${data.vehicleType} ${data.vehicleModel}`,
                issue: data.issueType || data.issueDesc, 
                location: data.custLocation,
            };
        });
        render(); 
    }, (error) => {
        console.error("Gagal mendengarkan pesanan baru:", error);
    });
}

// Mendengarkan Orderan SAYA (mekanikId: currentUserId) secara Realtime
function setupRealtimeMyOrderListener(uid) {
    const ordersRef = collection(db, "new_orders");
    const q = query(ordersRef, where("mekanikId", "==", uid));

    onSnapshot(q, (snapshot) => {
        STATE.myOrders = snapshot.docs.map(doc => {
            const data = doc.data();
            return {
                id: doc.id, 
                cust: data.custName,
                service: data.issueType || data.issueDesc,
                status: data.status,
                total: data.total || 0 
            };
        });
        render(); 
    }, (error) => {
        console.error("Gagal mendengarkan orderan saya:", error);
    });
}

// =========================================================
// 5. FUNGSI LOGIKA (Update Firestore)
// =========================================================

window.claimOrder = async function(id){
  const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in-progress').length;
  
  // Batasan Akun STANDAR
  if(!STATE.shop.isPro && currentOrdersInProgress >= STATE.shop.limit){
    alert(`Batas ${STATE.shop.limit} order aktif tercapai. Upgrade ke PRO untuk batas lebih tinggi.`);
    return;
  }
  
  if (!confirm(`Yakin ingin mengambil pesanan ID ${id.substring(0, 6)} dari ${STATE.shop.name}?`)) {
    return;
  }

  try {
      const orderRef = doc(db, "new_orders", id);
      await updateDoc(orderRef, {
          status: "in-progress",
          mekanikId: currentUserId,
          mekanikName: STATE.shop.name, 
          claimTime: new Date()
      });
      alert(`Pesanan ${id.substring(0, 6)} berhasil Anda ambil!`);
      // Render otomatis terjadi karena onSnapshot
  } catch (error) {
      console.error("Gagal mengambil pesanan:", error);
      alert("Terjadi kesalahan saat mengambil pesanan. Coba lagi.");
  }
}

window.finishOrder = async function(id) {
    const totalCostStr = prompt("Masukkan total biaya service (hanya angka):");
    if (totalCostStr === null) return; 

    const totalCost = parseInt(totalCostStr);

    if (isNaN(totalCost) || totalCost <= 0) {
        return alert("Input biaya tidak valid. Harus berupa angka positif.");
    }
    
    if (!confirm(`Yakin ingin menandai pesanan ${id.substring(0, 6)} selesai dengan biaya Rp ${formatCurrency(totalCost)}?`)) {
        return;
    }
    
    try {
        const orderRef = doc(db, "new_orders", id);
        await updateDoc(orderRef, {
            status: "selesai",
            total: totalCost, 
            finishTime: new Date()
        });
        alert("Pesanan berhasil diselesaikan!");
    } catch (error) {
        console.error("Gagal menyelesaikan pesanan:", error);
        alert("Terjadi kesalahan saat menyelesaikan pesanan. Coba lagi.");
    }
}

window.editProfile = async function(){
    if (!STATE.shop.isPro) {
        alert("Fitur Edit Profil hanya tersedia untuk akun PRO.");
        return;
    }
    
    const newName = prompt(`Masukkan Nama Bengkel baru (saat ini: ${STATE.shop.name}):`, STATE.shop.name);
    if (!newName) return; 
    
    const newWA = prompt(`Masukkan Nomor WA baru (saat ini: ${STATE.shop.wa}):`, STATE.shop.wa);
    if (!newWA) return; 
    
    try {
        const profileRef = doc(db, "mekanik_users", currentUserId);
        await updateDoc(profileRef, {
            shopName: newName,
            shopWA: newWA
        });
        alert("Profil berhasil diperbarui!");
        // Render otomatis terjadi setelah fetchAndRenderProfile (yang dipicu oleh onAuthStateChanged saat startup)
        // Atau Anda bisa panggil fetchAndRenderProfile(currentUserId) di sini jika perlu update yang lebih cepat
        await fetchAndRenderProfile(currentUserId);
    } catch (error) {
        console.error("Gagal memperbarui profil:", error);
        alert("Gagal memperbarui profil. Coba lagi.");
    }
}


// =========================================================
// 6. LOGIKA AUTENTIKASI FIREBASE & EVENT LISTENERS
// =========================================================

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUserId = user.uid;
        currentUserEmail = user.email; 
        
        // 1. Ambil dan tampilkan profil bengkel
        await fetchAndRenderProfile(currentUserId);
        
        // 2. Mulai mendengarkan pesanan baru (Realtime)
        setupRealtimeNewOrderListener();
        
        // 3. Mulai mendengarkan orderan yang sudah diambil oleh user ini (Realtime)
        setupRealtimeMyOrderListener(currentUserId);
        
    } else {
        console.log("Tidak ada pengguna yang login.");
        window.location.href = "login mekanik.html"; 
    }
});

// Implementasi Logout Firebase (untuk kedua tombol)
const handleLogout = () => {
    signOut(auth).then(() => {
        // Re            color: var(--blue);
            border-bottom: 2px solid var(--orange);
            padding-bottom: 5px;
            margin-top: 30px;
        }

        /* --- RINGKASAN PROFIL --- */
        .profile-summary {
            background-color: var(--card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .profile-summary div {
            flex: 1 1 200px;
            min-width: 200px;
        }
        .profile-summary strong {
            display: block;
            color: var(--orange);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .profile-summary p {
            margin: 0;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
        }

        /* --- TABEL PESANAN --- */
        .card {
            background-color: var(--card);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: var(--blue);
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        
        /* --- Tombol Aksi --- */
        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        .action-btn:hover { opacity: 0.8; }
        .btn-claim {
            background-color: #4CAF50; /* Hijau */
            color: white;
        }
        .btn-detail {
            background-color: var(--blue);
            color: white;
            margin-left: 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-pending { background-color: var(--orange); color: white; }
        .status-progress { background-color: #2196F3; color: white; }
        .status-done { background-color: #4CAF50; color: white; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .header h1 { font-size: 1.2em; }
            .profile-summary { flex-direction: column; }
            th, td { padding: 10px; }
            .action-btn { width: 100%; margin-top: 5px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1><i class="fas fa-tools"></i> Dashboard Mekanik</h1>
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <div class="container">

        <h2><i class="fas fa-user-circle"></i> Profil Bengkel</h2>
        <div class="profile-summary" id="profileSummary">
            <div>
                <strong>Nama Bengkel:</strong>
                <p id="shopNameDisplay">Memuat...</p>
            </div>
            <div>
                <strong>Alamat Bengkel:</strong>
                <p id="shopAddressDisplay">Memuat...</p>
            </div>
            <div>
                <strong>Nomor WhatsApp:</strong>
                <p id="shopWADisplay">Memuat...</p>
            </div>
            <div>
                <strong>Status Akun:</strong>
                <p id="accountStatusDisplay" class="status-badge status-done">Standar</p>
            </div>
            <div>
                <strong>Peringkat Bengkel:</strong>
                <p id="shopRatingDisplay">Memuat...</p>
            </div>
            <button class="action-btn btn-detail" onclick="window.location.href='edit_profile.html'">
                <i class="fas fa-edit"></i> Edit Profil
            </button>
        </div>

        <h2><i class="fas fa-bell"></i> Pesanan Baru Tersedia</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>ID Pesanan</th>
                        <th>Pelanggan</th>
                        <th>Kendaraan</th>
                        <th>Keluhan Utama</th>
                        <th>Lokasi</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="newOrdersTableBody">
                    <tr><td colspan="6">Memuat pesanan baru...</td></tr>
                </tbody>
            </table>
        </div>
        
        <h2><i class="fas fa-wrench"></i> Orderan Saya</h2>
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>ID Pesanan</th>
                        <th>Pelanggan</th>
                        <th>Service</th>
                        <th>Status</th>
                        <th>Total Biaya</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="myOrdersTableBody">
                    <tr><td colspan="6">Tidak ada orderan aktif.</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <script type="module">
        // =========================================================
        // 1. KONFIGURASI DAN IMPOR FIREBASE
        // =========================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc,
            collection, 
            query, 
            where, 
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"; 

        const firebaseConfig = {
            apiKey: "AIzaSyB_pygYC3UubxRWZScPO-GveCi8jh_zkdc",
            authDomain: "mechajob-b7360.firebaseapp.com",
            projectId: "mechajob-b7360",
            storageBucket: "mechajob-b7360.firebasestorage.app",
            messagingSenderId: "753002885541",
            appId: "1:753002885541:web:96e4964dbd300193ff384c",
            measurementId: "G-ZY3RS8WGP7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); 
        
        let currentUserId = null;
        
        // Data Global untuk menyimpan status dashboard
        const STATE = {
            // Ditambahkan 'rating'
            shop: { name: "Memuat...", address: "Memuat...", wa: "Memuat...", isPro: false, rating: 0 }, 
            customers: [], 
            myOrders: [],  
        };
        
        // =========================================================
        // 2. FUNGSI UTAMA RENDERING
        // =========================================================
        function render() {
            // A. Render Profil Bengkel
            document.getElementById("shopNameDisplay").textContent = STATE.shop.name;
            document.getElementById("shopAddressDisplay").textContent = STATE.shop.address;
            document.getElementById("shopWADisplay").textContent = STATE.shop.wa;
            
            // TAMPILKAN RATING
            const ratingDisplay = document.getElementById("shopRatingDisplay");
            if (STATE.shop.rating > 0) {
                 // Menampilkan ikon bintang
                const fullStars = Math.floor(STATE.shop.rating);
                let starsHTML = '';
                for (let i = 0; i < fullStars; i++) {
                    starsHTML += '<i class="fas fa-star" style="color: gold;"></i>';
                }
                if (STATE.shop.rating % 1 >= 0.5) {
                    starsHTML += '<i class="fas fa-star-half-alt" style="color: gold;"></i>';
                }
                ratingDisplay.innerHTML = `${STATE.shop.rating.toFixed(1)} ${starsHTML}`;
            } else {
                ratingDisplay.textContent = 'Belum ada rating';
            }
            
            const statusBadge = document.getElementById("accountStatusDisplay");
            statusBadge.textContent = STATE.shop.isPro ? "PRO" : "Standar";
            statusBadge.className = STATE.shop.isPro ? "status-badge status-done" : "status-badge status-pending";

            // B. Render Tabel Pesanan Baru (customers)
            const newOrdersBody = document.getElementById("newOrdersTableBody");
            newOrdersBody.innerHTML = ''; 

            if (STATE.customers.length === 0) {
                newOrdersBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:green;">Tidak ada pesanan baru saat ini. Santai!</td></tr>';
            } else {
                STATE.customers.forEach(order => {
                    const row = newOrdersBody.insertRow();
                    row.innerHTML = `
                        <td>${order.id.substring(0, 6)}...</td>
                        <td>${order.name}</td>
                        <td>${order.vehicle}</td>
                        <td>${order.issue}</td>
                        <td>${order.location}</td>
                        <td>
                            <button class="action-btn btn-claim" onclick="window.claimOrder('${order.id}')">Ambil</button>
                        </td>
                    `;
                });
            }

            // C. Render Tabel Orderan Saya (myOrders)
            const myOrdersBody = document.getElementById("myOrdersTableBody");
            myOrdersBody.innerHTML = ''; 

            if (STATE.myOrders.length === 0) {
                 myOrdersBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Anda belum mengambil orderan. Ambil dari daftar di atas.</td></tr>';
            } else {
                 STATE.myOrders.forEach(order => {
                    const statusClass = order.status === 'in-progress' ? 'status-progress' : 'status-done';
                    const totalDisplay = order.total ? `Rp ${order.total.toLocaleString('id-ID')}` : 'Belum selesai';
                    const actionButton = order.status === 'in-progress' 
                                         ? `<button class="action-btn btn-claim" onclick="window.finishOrder('${order.id}')">Selesaikan</button>`
                                         : `<button class="action-btn btn-detail" disabled>Selesai</button>`;
                                         
                    const row = myOrdersBody.insertRow();
                    row.innerHTML = `
                        <td>${order.id.substring(0, 6)}...</td>
                        <td>${order.cust}</td>
                        <td>${order.service}</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>${totalDisplay}</td>
                        <td>${actionButton}</td>
                    `;
                });
            }
        }
        
        // =========================================================
        // 3. LOGIKA FIREBASE LISTENERS
        // =========================================================
        
        async function fetchAndRenderProfile(uid) {
            try {
                const docRef = doc(db, "mekanik_users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    STATE.shop = {
                        name: data.shopName || "Nama Bengkel Belum Disetel",
                        address: data.shopAddress || "Alamat Belum Disetel",
                        wa: data.shopWA || "WA Belum Disetel",
                        isPro: data.isPro || false,
                        // AMBIL FIELD RATING BARU
                        rating: data.rating || 0 
                    };
                    render();
                } else {
                    console.warn("Profil mekanik tidak ditemukan.");
                }
            } catch (error) {
                console.error("Gagal memuat profil:", error);
            }
        }

        // FUNGSI Mendengarkan Pesanan BARU (status: pending) secara Realtime
        function setupRealtimeNewOrderListener() {
            const ordersRef = collection(db, "new_orders");
            const q = query(ordersRef, where("status", "==", "pending"));

            onSnapshot(q, (snapshot) => {
                const pendingOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    pendingOrders.push({
                        id: doc.id, 
                        name: data.custName,
                        vehicle: data.vehicle || `${data.vehicleType} ${data.vehicleModel}`,
                        issue: data.issueType || data.issueDesc, 
                        location: data.custLocation,
                        data: data,
                    });
                });
                
                STATE.customers = pendingOrders;
                console.log("Pesanan baru dimuat:", STATE.customers.length);
                render(); 
            }, (error) => {
                console.error("Gagal mendengarkan pesanan baru:", error);
                document.getElementById("newOrdersTableBody").innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Gagal memuat data: Cek koneksi Firebase.</td></tr>';
            });
        }
        
        // FUNGSI Mendengarkan Orderan SAYA (mekanikId: currentUserId) secara Realtime
        function setupRealtimeMyOrderListener(uid) {
            const ordersRef = collection(db, "new_orders");
            const q = query(ordersRef, where("mekanikId", "==", uid));

            onSnapshot(q, (snapshot) => {
                const myOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    myOrders.push({
                        id: doc.id, 
                        cust: data.custName,
                        service: data.issueType || data.issueDesc,
                        status: data.status,
                        total: data.total || 0 
                    });
                });
                
                STATE.myOrders = myOrders;
                console.log("Orderan Saya dimuat:", STATE.myOrders.length);
                render(); 
            }, (error) => {
                console.error("Gagal mendengarkan orderan saya:", error);
            });
        }


        // =========================================================
        // 4. LOGIKA AUTENTIKASI DAN STARTUP
        // =========================================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                await fetchAndRenderProfile(currentUserId);
                
                setupRealtimeNewOrderListener();
                
                setupRealtimeMyOrderListener(currentUserId);
                
            } else {
                window.location.href = "login mekanik.html";
            }
        });
        
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).catch((error) => {
                console.error("Logout error:", error);
                alert("Gagal logout. Coba lagi.");
            });
        });


        // =========================================================
        // 5. FUNGSI LOGIKA TOMBOL (Klaim dan Selesaikan)
        // =========================================================

        window.claimOrder = async function(id){ 
            if (!currentUserId || !STATE.shop.name) {
                alert("Profil tidak lengkap. Silakan login atau periksa data bengkel Anda.");
                return;
            }
            
            const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in-progress').length;
            const MAX_ORDERS = STATE.shop.isPro ? 999 : 5;
            
            if(currentOrdersInProgress >= MAX_ORDERS){
                alert(`Batas ${MAX_ORDERS} order aktif tercapai. Upgrade ke PRO untuk batas lebih tinggi.`);
                return;
            }
            
            if (!confirm(`Yakin ingin mengambil pesanan ID ${id.substring(0, 6)}?`)) {
                return;
            }

            try {
                const orderRef = doc(db, "new_orders", id);
                await updateDoc(orderRef, {
                    status: "in-progress",
                    mekanikId: currentUserId,
                    mekanikName: STATE.shop.name, 
                    claimTime: new Date()
                });
                
                alert(`Pesanan ${id.substring(0, 6)} berhasil Anda ambil! Cek di bagian "Orderan Saya".`);

            } catch (error) {
                console.error("Gagal mengambil pesanan:", error);
                alert("Terjadi kesalahan saat mengambil pesanan. Coba lagi.");
            }
        }
        
        window.finishOrder = async function(id) {
             const totalCost = prompt("Masukkan total biaya service (hanya angka):");
             if (totalCost === null || isNaN(parseInt(totalCost))) {
                 return alert("Pembatalan atau input biaya tidak valid.");
             }
             
             if (!confirm(`Yakin ingin menandai pesanan ${id.substring(0, 6)} selesai dengan biaya Rp ${parseInt(totalCost).toLocaleString('id-ID')}?`)) {
                 return;
             }
             
             try {
                const orderRef = doc(db, "new_orders", id);
                await updateDoc(orderRef, {
                    status: "selesai",
                    total: parseInt(totalCost),
                    finishTime: new Date()
     }</td>
                        <td>
                            <button class="action-btn btn-claim" onclick="window.claimOrder('${order.id}')">Ambil</button>
                        </td>
                    `;
                });
            }

            // C. Render Tabel Orderan Saya (myOrders)
            const myOrdersBody = document.getElementById("myOrdersTableBody");
            myOrdersBody.innerHTML = ''; 

            if (STATE.myOrders.length === 0) {
                 myOrdersBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Anda belum mengambil orderan. Ambil dari daftar di atas.</td></tr>';
            } else {
                 STATE.myOrders.forEach(order => {
                    const statusClass = order.status === 'in-progress' ? 'status-progress' : 'status-done';
                    const totalDisplay = order.total ? `Rp ${order.total.toLocaleString('id-ID')}` : 'Belum selesai';
                    const actionButton = order.status === 'in-progress' 
                                         ? `<button class="action-btn btn-claim" onclick="window.finishOrder('${order.id}')">Selesaikan</button>`
                                         : `<button class="action-btn btn-detail" disabled>Selesai</button>`;
                                         
                    const row = myOrdersBody.insertRow();
                    row.innerHTML = `
                        <td>${order.id.substring(0, 6)}...</td>
                        <td>${order.cust}</td>
                        <td>${order.service}</td>
                        <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                        <td>${totalDisplay}</td>
                        <td>${actionButton}</td>
                    `;
                });
            }
        }
        
        // =========================================================
        // 3. LOGIKA FIREBASE LISTENERS
        // =========================================================
        
        async function fetchAndRenderProfile(uid) {
            try {
                const docRef = doc(db, "mekanik_users", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    STATE.shop = {
                        name: data.shopName || "Nama Bengkel Belum Disetel",
                        address: data.shopAddress || "Alamat Belum Disetel",
                        wa: data.shopWA || "WA Belum Disetel",
                        isPro: data.isPro || false
                    };
                    render();
                } else {
                    console.warn("Profil mekanik tidak ditemukan.");
                }
            } catch (error) {
                console.error("Gagal memuat profil:", error);
            }
        }

        function setupRealtimeNewOrderListener() {
            const ordersRef = collection(db, "new_orders");
            const q = query(ordersRef, where("status", "==", "pending"));

            onSnapshot(q, (snapshot) => {
                const pendingOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    pendingOrders.push({
                        id: doc.id, 
                        name: data.custName,
                        vehicle: data.vehicle || `${data.vehicleType} ${data.vehicleModel}`,
                        issue: data.issueType || data.issueDesc, 
                        location: data.custLocation,
                        data: data,
                    });
                });
                
                STATE.customers = pendingOrders;
                console.log("Pesanan baru dimuat:", STATE.customers.length);
                render(); 
            }, (error) => {
                console.error("Gagal mendengarkan pesanan baru:", error);
                document.getElementById("newOrdersTableBody").innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Gagal memuat data: Cek koneksi Firebase.</td></tr>';
            });
        }
        
        function setupRealtimeMyOrderListener(uid) {
            const ordersRef = collection(db, "new_orders");
            const q = query(ordersRef, where("mekanikId", "==", uid));

            onSnapshot(q, (snapshot) => {
                const myOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    myOrders.push({
                        id: doc.id, 
                        cust: data.custName,
                        service: data.issueType || data.issueDesc,
                        status: data.status,
                        total: data.total || 0 
                    });
                });
                
                STATE.myOrders = myOrders;
                console.log("Orderan Saya dimuat:", STATE.myOrders.length);
                render(); 
            }, (error) => {
                console.error("Gagal mendengarkan orderan saya:", error);
            });
        }


        // =========================================================
        // 4. LOGIKA AUTENTIKASI DAN STARTUP
        // =========================================================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                
                await fetchAndRenderProfile(currentUserId);
                
                setupRealtimeNewOrderListener();
                
                setupRealtimeMyOrderListener(currentUserId);
                
            } else {
                window.location.href = "login mekanik.html";
            }
        });
        
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).catch((error) => {
                console.error("Logout error:", error);
                alert("Gagal logout. Coba lagi.");
            });
        });


        // =========================================================
        // 5. FUNGSI LOGIKA TOMBOL (Klaim dan Selesaikan)
        // =========================================================

        window.claimOrder = async function(id){ 
            if (!currentUserId || !STATE.shop.name) {
                alert("Profil tidak lengkap. Silakan login atau periksa data bengkel Anda.");
                return;
            }
            
            const currentOrdersInProgress = STATE.myOrders.filter(o => o.status === 'in-progress').length;
            const MAX_ORDERS = STATE.shop.isPro ? 999 : 5;
            
            if(currentOrdersInProgress >= MAX_ORDERS){
                alert(`Batas ${MAX_ORDERS} order aktif tercapai. Upgrade ke PRO untuk batas lebih tinggi.`);
                return;
            }
            
            if (!confirm(`Yakin ingin mengambil pesanan ID ${id.substring(0, 6)}?`)) {
                return;
            }

            try {
                const orderRef = doc(db, "new_orders", id);
                await updateDoc(orderRef, {
                    status: "in-progress",
                    mekanikId: currentUserId,
                    mekanikName: STATE.shop.name, 
                    claimTime: new Date()
                });
                
                alert(`Pesanan ${id.substring(0, 6)} berhasil Anda ambil! Cek di bagian "Orderan Saya".`);

            } catch (error) {
                console.error("Gagal mengambil pesanan:", error);
                alert("Terjadi kesalahan saat mengambil pesanan. Coba lagi.");
            }
        }
        
        window.finishOrder = async function(id) {
             const totalCost = prompt("Masukkan total biaya service (hanya angka):");
             if (totalCost === null || isNaN(parseInt(totalCost))) {
                 return alert("Pembatalan atau input biaya tidak valid.");
             }
             
             if (!confirm(`Yakin ingin menandai pesanan ${id.substring(0, 6)} selesai dengan biaya Rp ${parseInt(totalCost).toLocaleString('id-ID')}?`)) {
                 return;
             }
             
             try {
                const orderRef = doc(db, "new_orders", id);
                await updateDoc(orderRef, {
                    status: "selesai",
                    total: parseInt(totalCost),
                    finishTime: new Date()
                });
                alert("Pesanan berhasil diselesaikan!");
            } catch (error) {
                console.error("Gagal menyelesaikan pesanan:", error);
                alert("Terjadi kesalahan saat menyelesaikan pesanan. Coba lagi.");
            }
        }
    </script>
</body>
</html>
